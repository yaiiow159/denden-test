---
config:
  theme: neo
---
sequenceDiagram
    participant User as 用戶
    participant SCSP as SCSP App
    participant EMSP as EMSP
    participant CPO as CPO
    participant CP as Charge Point

    rect rgb(200, 150, 255)
    note over User,CP: 階段 1：啟動充電 Session
    
    User->>SCSP: 選擇地點並請求啟動充電
    activate SCSP
    SCSP->>EMSP: POST /commands/START_SESSION
    activate EMSP
    note right of SCSP: 包含 token、location_id、evse_uid
    
    EMSP->>CPO: POST /commands/START_SESSION
    activate CPO
    note right of EMSP: CommandForward 至 CPO
    
    CPO->>CP: RemoteStartTransaction.req
    activate CP
    note right of CPO: 透過 OCPP 向充電樁發送啟動指令
    
    CP-->>CPO: RemoteStartTransaction.conf
    note left of CP: 充電樁確認接受
    deactivate CP
    
    CPO-->>EMSP: CommandResponse (ACCEPTED)
    note left of CPO: 回覆命令已接受
    deactivate CPO
    
    EMSP-->>SCSP: 200 OK - CommandResponse
    note left of EMSP: result: ACCEPTED
    deactivate EMSP
    
    SCSP-->>User: 充電啟動中...
    deactivate SCSP
    end
    rect rgb(200, 220, 150)
    note over User,CP: 階段 2：Session 狀態更新 (PENDING to ACTIVE)
    
    User->>CP: 插入充電槍到 EV
    activate CP
    
    CP->>CPO: StartTransaction.req
    activate CPO
    note right of CP: 回報交易開始 Transaction ID
    
    CPO->>CPO: 建立 Session 物件
    note right of CPO: status: PENDING, kwh: 0.00
    
    CPO->>EMSP: PUT /sessions/SESSION_ID
    activate EMSP
    note right of CPO: 推送 Session (PENDING)
    
    EMSP-->>CPO: 200 OK
    deactivate EMSP
    
    CPO->>EMSP: POST /commands/result
    activate EMSP
    note right of CPO: 回傳 CommandResult (ACCEPTED)
    
    EMSP-->>CPO: 200 OK
    deactivate EMSP
    
    CP->>CP: 開始充電
    note right of CP: 電流開始傳輸
    
    CP->>CPO: MeterValues (Charging)
    note right of CP: 回報即時電量、功率資訊
    
    CPO->>CPO: 更新 Session 狀態
    end